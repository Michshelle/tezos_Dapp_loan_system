{"ast":null,"code":"import _regeneratorRuntime from\"/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect}from\"react\";import{Tezos}from\"@taquito/taquito\";import{TezBridgeSigner}from\"@taquito/tezbridge-signer\";import Menu from\"./Menu\";import\"./App.css\";import\"./bulma.css\";/* PUT HERE THE CONTRACT ADDRESS FOR YOUR OWN SANDBOX! */var KT_ledger=\"KT1RigSYegqvkCkEoHMfgXY4XLgknZufrFEa\";var KT_token=\"KT1GxBkvP5aiAtBu9MwAWBgxRpaCeLCcBfNj\";var shortenAddress=function shortenAddress(addr){return addr.slice(0,6)+\"...\"+addr.slice(addr.length-6);};var App=function App(){var _useState=useState(undefined),_useState2=_slicedToArray(_useState,2),tokenInstance=_useState2[0],setTokenInstance=_useState2[1];var _useState3=useState(undefined),_useState4=_slicedToArray(_useState3,2),xtzPrice=_useState4[0],setXtzPrice=_useState4[1];var _useState5=useState(undefined),_useState6=_slicedToArray(_useState5,2),ledgerInstance=_useState6[0],setLedgerInstance=_useState6[1];var _useState7=useState(undefined),_useState8=_slicedToArray(_useState7,2),ledgerInfo=_useState8[0],setLedgerInfo=_useState8[1];var _useState9=useState(undefined),_useState10=_slicedToArray(_useState9,2),userAddress=_useState10[0],setUserAddress=_useState10[1];var _useState11=useState(undefined),_useState12=_slicedToArray(_useState11,2),balance=_useState12[0],setBalance=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),isOwner=_useState14[0],setIsOwner=_useState14[1];var _useState15=useState(0),_useState16=_slicedToArray(_useState15,2),contractBalance=_useState16[0],setContractBalance=_useState16[1];var tezbridge=window.tezbridge;var initWallet=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var fetch,req,response,_xtz,_address,_balance,storage,_contractBalance;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;/*............remove...........*/fetch=require('node-fetch');_context.next=4;return fetch(\"https://api-pub.bitfinex.com/v2/ticker/tXTZUSD\");case 4:req=_context.sent;_context.next=7;return req.json();case 7:response=_context.sent;_xtz=Number(response[0]);setXtzPrice(_xtz);/*.............remove..........*/_context.next=12;return tezbridge.request({method:\"get_source\"});case 12:_address=_context.sent;setUserAddress(_address);// gets user's balance\n_context.next=16;return Tezos.tz.getBalance(_address);case 16:_balance=_context.sent;setBalance(_balance);_context.next=20;return tokenInstance.storage();case 20:storage=_context.sent;if(!(storage.owner===_address)){_context.next=27;break;}setIsOwner(true);_context.next=25;return Tezos.tz.getBalance(KT_token);case 25:_contractBalance=_context.sent;setContractBalance(_contractBalance.c[0]);case 27:_context.next=32;break;case 29:_context.prev=29;_context.t0=_context[\"catch\"](0);console.log(\"error fetching the address or balance:\",_context.t0);case 32:case\"end\":return _context.stop();}}},_callee,null,[[0,29]]);}));return function initWallet(){return _ref.apply(this,arguments);};}();var mint=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(mintNumber,xtz){var price,op,newBalance;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:// sends mint request\nprice=mintNumber/1000000/xtz;_context2.next=3;return tokenInstance.methods.mint(mintNumber).send({amount:price.toFixed(4)});case 3:op=_context2.sent;_context2.next=6;return op.confirmation(30);case 6:if(!(op.includedInBlock!==Infinity)){_context2.next=13;break;}_context2.next=9;return Tezos.tz.getBalance(userAddress);case 9:newBalance=_context2.sent;setBalance(newBalance);_context2.next=14;break;case 13:console.log(\"error\");case 14:case\"end\":return _context2.stop();}}},_callee2);}));return function mint(_x,_x2){return _ref2.apply(this,arguments);};}();useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var tokenContract,ledgerContract,ledgerStorage,ledgerInfos;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:// sets RPC\nTezos.setProvider({rpc:\"https://tezos-dev.cryptonomic-infra.tech\",signer:new TezBridgeSigner()});// fetches contract storage\n_context3.next=3;return Tezos.contract.at(KT_token);case 3:tokenContract=_context3.sent;setTokenInstance(tokenContract);_context3.next=7;return Tezos.contract.at(KT_ledger);case 7:ledgerContract=_context3.sent;setLedgerInstance(ledgerContract);_context3.next=11;return ledgerContract.storage();case 11:ledgerStorage=_context3.sent;// creates token contract info\nledgerInfos=[ledgerStorage.debtor,ledgerStorage.totalCredit];setLedgerInfo(ledgerInfos);case 14:case\"end\":return _context3.stop();}}},_callee3);}))();},[]);return React.createElement(\"div\",{className:\"App\"},React.createElement(\"div\",{className:\"wallet\"},balance===undefined?React.createElement(\"button\",{className:\"button is-info is-light is-small\",onClick:initWallet},\"Connect your wallet\"):React.createElement(React.Fragment,null,React.createElement(\"span\",{className:\"balance\"},\"\\uA729 \",balance.toNumber()/1000000),React.createElement(\"div\",{className:\"field is-grouped\"},React.createElement(\"p\",{className:\"control\"},React.createElement(\"button\",{className:\"button is-success is-light is-small\",onClick:/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:setUserAddress(undefined);setBalance(undefined);setIsOwner(undefined);setXtzPrice(undefined);_context4.next=6;return initWallet();case 6:case\"end\":return _context4.stop();}}},_callee4);}))},shortenAddress(userAddress))),isOwner&&React.createElement(\"p\",{className:\"control\"},React.createElement(\"button\",{className:\"button is-warning is-light is-small\",onClick:/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:mint(document.getElementById(\"tokenNumber\").value,xtzPrice);document.getElementById(\"tokenNumber\").value=\"\";case 2:case\"end\":return _context5.stop();}}},_callee5);}))},\"Mint token\"),React.createElement(\"input\",{type:\"text\",id:\"tokenNumber\"}))))),React.createElement(\"div\",{className:\"app-title\"},\"Flexible Loans\"),React.createElement(\"div\",{className:\"logo\"},React.createElement(\"img\",{src:\"coffee-maker.png\",alt:\"logo\"})),typeof ledgerInfo==='undefined'?\"Loading the ledger info...\":React.createElement(Menu,{ledgerInfo:ledgerInfo,tokenInstance:tokenInstance,ledgerInstance:ledgerInstance,userAddress:userAddress,setBalance:setBalance,Tezos:Tezos}));};export default App;","map":{"version":3,"sources":["/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/src/App.js"],"names":["React","useState","useEffect","Tezos","TezBridgeSigner","Menu","KT_ledger","KT_token","shortenAddress","addr","slice","length","App","undefined","tokenInstance","setTokenInstance","xtzPrice","setXtzPrice","ledgerInstance","setLedgerInstance","ledgerInfo","setLedgerInfo","userAddress","setUserAddress","balance","setBalance","isOwner","setIsOwner","contractBalance","setContractBalance","tezbridge","window","initWallet","fetch","require","req","json","response","_xtz","Number","request","method","_address","tz","getBalance","_balance","storage","owner","_contractBalance","c","console","log","mint","mintNumber","xtz","price","methods","send","amount","toFixed","op","confirmation","includedInBlock","Infinity","newBalance","setProvider","rpc","signer","contract","at","tokenContract","ledgerContract","ledgerStorage","ledgerInfos","debtor","totalCredit","toNumber","document","getElementById","value"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { Tezos } from \"@taquito/taquito\";\nimport { TezBridgeSigner } from \"@taquito/tezbridge-signer\";\nimport Menu from \"./Menu\";\nimport \"./App.css\";\nimport \"./bulma.css\";\n\n\n/* PUT HERE THE CONTRACT ADDRESS FOR YOUR OWN SANDBOX! */\nconst KT_ledger = \"KT1RigSYegqvkCkEoHMfgXY4XLgknZufrFEa\"\nconst KT_token = \"KT1GxBkvP5aiAtBu9MwAWBgxRpaCeLCcBfNj\"\n\n\nconst shortenAddress = addr =>\n  addr.slice(0, 6) + \"...\" + addr.slice(addr.length - 6);\n\n  \nconst App = () => {\n  const [tokenInstance, setTokenInstance] = useState(undefined);\n  const [xtzPrice, setXtzPrice] = useState(undefined);\n  const [ledgerInstance, setLedgerInstance] = useState(undefined);\n  const [ledgerInfo, setLedgerInfo] = useState(undefined);\n  const [userAddress, setUserAddress] = useState(undefined);\n  const [balance, setBalance] = useState(undefined);\n  const [isOwner, setIsOwner] = useState(false);\n  const [contractBalance, setContractBalance] = useState(0);\n  const tezbridge = window.tezbridge;\n\n\n  const initWallet = async () => {\n    try {\n      /*............remove...........*/\n      const fetch = require('node-fetch') \n      const req = await fetch(\"https://api-pub.bitfinex.com/v2/ticker/tXTZUSD\")\n      const response = await req.json()               \n      const _xtz = Number(response[0])\n      setXtzPrice(_xtz);\n      /*.............remove..........*/\n      const _address = await tezbridge.request({ method: \"get_source\" });\n      setUserAddress(_address);\n      // gets user's balance\n      const _balance = await Tezos.tz.getBalance(_address);\n      setBalance(_balance);\n      const storage = await tokenInstance.storage();\n      if (storage.owner === _address) {\n        setIsOwner(true);\n        const _contractBalance = await Tezos.tz.getBalance(KT_token);\n        setContractBalance(_contractBalance.c[0]);\n      }\n    } catch (error) {\n      console.log(\"error fetching the address or balance:\", error);\n    }\n  };\n\n  const mint = async (mintNumber,xtz) => {\n    // sends mint request\n    const price = mintNumber / 1000000 / xtz;\n    const op = await tokenInstance.methods.mint(mintNumber).send({ amount: price.toFixed(4) });\n    // waits for confirmation\n    await op.confirmation(30);\n    // if confirmed\n    if (op.includedInBlock !== Infinity) {\n      const newBalance = await Tezos.tz.getBalance(userAddress);\n      setBalance(newBalance);\n    } else {\n      console.log(\"error\");\n    }\n  };\n\n  useEffect(() => {\n    (async () => {\n      // sets RPC\n      Tezos.setProvider({\n        rpc: \"https://tezos-dev.cryptonomic-infra.tech\",\n        signer: new TezBridgeSigner()\n      });\n      // fetches contract storage\n      const tokenContract = await Tezos.contract.at(KT_token);\n      setTokenInstance(tokenContract);\n      const ledgerContract = await Tezos.contract.at(KT_ledger);\n      setLedgerInstance(ledgerContract);\n      const ledgerStorage = await ledgerContract.storage();\n      // creates token contract info\n      let ledgerInfos = [ledgerStorage.debtor,ledgerStorage.totalCredit];\n      setLedgerInfo(ledgerInfos);\n    })();\n  }, []);\n  return (\n    <div className=\"App\">\n      <div className=\"wallet\">\n        {balance === undefined ? (\n          <button\n            className=\"button is-info is-light is-small\"\n            onClick={initWallet}\n          >\n            Connect your wallet\n          </button>\n        ) : (\n          <>\n            <span className=\"balance\">ꜩ {balance.toNumber() / 1000000}</span>\n            <div className=\"field is-grouped\">\n              <p className=\"control\">\n                <button\n                  className=\"button is-success is-light is-small\"\n                  onClick={async () => {\n                    setUserAddress(undefined);\n                    setBalance(undefined);\n                    setIsOwner(undefined);\n                    setXtzPrice(undefined);\n                    await initWallet();\n                  }}\n                >\n                  {shortenAddress(userAddress)}\n                </button>\n              </p>\n              {isOwner && (\n                <p className=\"control\">\n                  <button\n                    className=\"button is-warning is-light is-small\"\n                    onClick={async () => {\n                     mint(document.getElementById(\"tokenNumber\").value,xtzPrice);\n                     document.getElementById(\"tokenNumber\").value = \"\";\n                    }\n                    }\n                  >\n                    Mint token\n                  </button>\n                  <input type=\"text\" id=\"tokenNumber\"></input>\n                </p>\n              )}\n            </div>\n          </>\n        )}\n      </div>\n      <div className=\"app-title\">Flexible Loans</div>\n      <div className=\"logo\">\n        <img src=\"coffee-maker.png\" alt=\"logo\" />\n      </div>\n      {typeof ledgerInfo === 'undefined' ? (\n        \"Loading the ledger info...\"\n      ) : (\n        <Menu\n          ledgerInfo={ledgerInfo}\n          tokenInstance={tokenInstance}\n          ledgerInstance={ledgerInstance}\n          userAddress={userAddress}\n          setBalance={setBalance}\n          Tezos={Tezos}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _regeneratorRuntime from\"/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect}from\"react\";import{Tezos}from\"@taquito/taquito\";import{TezBridgeSigner}from\"@taquito/tezbridge-signer\";import Menu from\"./Menu\";import\"./App.css\";import\"./bulma.css\";/* PUT HERE THE CONTRACT ADDRESS FOR YOUR OWN SANDBOX! */var contractAddress=\"KT1VzAcfDEqEUSShMDsRuav3gRPvDK5ETB58\";var shortenAddress=function shortenAddress(addr){return addr.slice(0,6)+\"...\"+addr.slice(addr.length-6);};var mutezToTez=function mutezToTez(mutez){return Math.round((parseInt(mutez)/1000000+Number.EPSILON)*100)/100;};var App=function App(){var _useState=useState(undefined),_useState2=_slicedToArray(_useState,2),contractInstance=_useState2[0],setContractInstance=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),coffeeMenu=_useState4[0],setCoffeeMenu=_useState4[1];var _useState5=useState(undefined),_useState6=_slicedToArray(_useState5,2),userAddress=_useState6[0],setUserAddress=_useState6[1];var _useState7=useState(undefined),_useState8=_slicedToArray(_useState7,2),balance=_useState8[0],setBalance=_useState8[1];var _useState9=useState(undefined),_useState10=_slicedToArray(_useState9,2),userPoints=_useState10[0],setUserPoints=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),isOwner=_useState12[0],setIsOwner=_useState12[1];var _useState13=useState(0),_useState14=_slicedToArray(_useState13,2),contractBalance=_useState14[0],setContractBalance=_useState14[1];var tezbridge=window.tezbridge;var initWallet=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _address,_balance,storage,points,_contractBalance;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return tezbridge.request({method:\"get_source\"});case 3:_address=_context.sent;setUserAddress(_address);// gets user's balance\n_context.next=7;return Tezos.tz.getBalance(_address);case 7:_balance=_context.sent;setBalance(_balance);// gets user's points\n_context.next=11;return contractInstance.storage();case 11:storage=_context.sent;points=storage.customers.get(_address);setUserPoints(parseInt(points));// compares user's address with owner's address\nif(!(storage.owner===_address)){_context.next=20;break;}setIsOwner(true);_context.next=18;return Tezos.tz.getBalance(contractAddress);case 18:_contractBalance=_context.sent;setContractBalance(_contractBalance.c[0]);case 20:_context.next=25;break;case 22:_context.prev=22;_context.t0=_context[\"catch\"](0);console.log(\"error fetching the address or balance:\",_context.t0);case 25:case\"end\":return _context.stop();}}},_callee,null,[[0,22]]);}));return function initWallet(){return _ref.apply(this,arguments);};}();var withdraw=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var op,newBalance;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return contractInstance.methods.withdraw([[\"unit\"]]).send();case 2:op=_context2.sent;_context2.next=5;return op.confirmation(1);case 5:if(!(op.includedInBlock!==Infinity)){_context2.next=12;break;}_context2.next=8;return Tezos.tz.getBalance(userAddress);case 8:newBalance=_context2.sent;setBalance(newBalance);_context2.next=13;break;case 12:console.log(\"error\");case 13:case\"end\":return _context2.stop();}}},_callee2);}));return function withdraw(){return _ref2.apply(this,arguments);};}();useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var contract,storage,coffees,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step,key;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:// sets RPC\nTezos.setProvider({rpc:\"http://localhost:8732\",signer:new TezBridgeSigner()});// fetches contract storage\n_context3.next=3;return Tezos.contract.at(contractAddress);case 3:contract=_context3.sent;setContractInstance(contract);_context3.next=7;return contract.storage();case 7:storage=_context3.sent;// creates coffee menu\ncoffees=[];_iteratorNormalCompletion=true;_didIteratorError=false;_iteratorError=undefined;_context3.prev=12;for(_iterator=storage.menu.keys()[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){key=_step.value;coffees.push({name:key,price:storage.menu.get(key).c[0]});}// updates state\n_context3.next=20;break;case 16:_context3.prev=16;_context3.t0=_context3[\"catch\"](12);_didIteratorError=true;_iteratorError=_context3.t0;case 20:_context3.prev=20;_context3.prev=21;if(!_iteratorNormalCompletion&&_iterator.return!=null){_iterator.return();}case 23:_context3.prev=23;if(!_didIteratorError){_context3.next=26;break;}throw _iteratorError;case 26:return _context3.finish(23);case 27:return _context3.finish(20);case 28:setCoffeeMenu(coffees);case 29:case\"end\":return _context3.stop();}}},_callee3,null,[[12,16,20,28],[21,,23,27]]);}))();},[]);return React.createElement(\"div\",{className:\"App\"},React.createElement(\"div\",{className:\"wallet\"},balance===undefined?React.createElement(\"button\",{className:\"button is-info is-light is-small\",onClick:initWallet},\"Connect your wallet\"):React.createElement(React.Fragment,null,React.createElement(\"span\",{className:\"balance\"},\"\\uA729 \",balance.toNumber()/1000000),React.createElement(\"div\",{className:\"field is-grouped\"},React.createElement(\"p\",{className:\"control\"},React.createElement(\"button\",{className:\"button is-success is-light is-small\",onClick:/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:setUserAddress(undefined);setBalance(undefined);setUserPoints(undefined);setIsOwner(undefined);_context4.next=6;return initWallet();case 6:case\"end\":return _context4.stop();}}},_callee4);}))},shortenAddress(userAddress))),isOwner&&React.createElement(\"p\",{className:\"control\"},React.createElement(\"button\",{className:\"button is-warning is-light is-small\",onClick:withdraw},\"Withdraw \\uA729 \",mutezToTez(contractBalance)))))),React.createElement(\"div\",{className:\"app-title\"},\"Caf\\xE9 Tezos\"),React.createElement(\"div\",{className:\"logo\"},React.createElement(\"img\",{src:\"coffee-maker.png\",alt:\"logo\"})),coffeeMenu.length===0?\"Loading the menu...\":React.createElement(Menu,{coffeeMenu:coffeeMenu,contractInstance:contractInstance,userAddress:userAddress,setBalance:setBalance,Tezos:Tezos,userPoints:userPoints,setUserPoints:setUserPoints}));};export default App;","map":{"version":3,"sources":["/Users/shengyisong/Documents/githubs/tezos-react-tutorial/client/src/App.js"],"names":["React","useState","useEffect","Tezos","TezBridgeSigner","Menu","contractAddress","shortenAddress","addr","slice","length","mutezToTez","mutez","Math","round","parseInt","Number","EPSILON","App","undefined","contractInstance","setContractInstance","coffeeMenu","setCoffeeMenu","userAddress","setUserAddress","balance","setBalance","userPoints","setUserPoints","isOwner","setIsOwner","contractBalance","setContractBalance","tezbridge","window","initWallet","request","method","_address","tz","getBalance","_balance","storage","points","customers","get","owner","_contractBalance","c","console","log","withdraw","methods","send","op","confirmation","includedInBlock","Infinity","newBalance","setProvider","rpc","signer","contract","at","coffees","menu","keys","key","push","name","price","toNumber"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { Tezos } from \"@taquito/taquito\";\nimport { TezBridgeSigner } from \"@taquito/tezbridge-signer\";\nimport Menu from \"./Menu\";\nimport \"./App.css\";\nimport \"./bulma.css\";\n\n/* PUT HERE THE CONTRACT ADDRESS FOR YOUR OWN SANDBOX! */\nconst contractAddress = \"KT1VzAcfDEqEUSShMDsRuav3gRPvDK5ETB58\";\n\nconst shortenAddress = addr =>\n  addr.slice(0, 6) + \"...\" + addr.slice(addr.length - 6);\n\nconst mutezToTez = mutez =>\n  Math.round((parseInt(mutez) / 1000000 + Number.EPSILON) * 100) / 100;\n\nconst App = () => {\n  const [contractInstance, setContractInstance] = useState(undefined);\n  const [coffeeMenu, setCoffeeMenu] = useState([]);\n  const [userAddress, setUserAddress] = useState(undefined);\n  const [balance, setBalance] = useState(undefined);\n  const [userPoints, setUserPoints] = useState(undefined);\n  const [isOwner, setIsOwner] = useState(false);\n  const [contractBalance, setContractBalance] = useState(0);\n  const tezbridge = window.tezbridge;\n\n  const initWallet = async () => {\n    try {\n      // sets rpc host\n      /*const rpc = await tezbridge.request({\n        method: \"set_host\",\n        host: \"http://localhost:8732\"\n      });*/\n      // gets user's address\n      const _address = await tezbridge.request({ method: \"get_source\" });\n      setUserAddress(_address);\n      // gets user's balance\n      const _balance = await Tezos.tz.getBalance(_address);\n      setBalance(_balance);\n      // gets user's points\n      const storage = await contractInstance.storage();\n      const points = storage.customers.get(_address);\n      setUserPoints(parseInt(points));\n      // compares user's address with owner's address\n      if (storage.owner === _address) {\n        setIsOwner(true);\n        const _contractBalance = await Tezos.tz.getBalance(contractAddress);\n        setContractBalance(_contractBalance.c[0]);\n      }\n    } catch (error) {\n      console.log(\"error fetching the address or balance:\", error);\n    }\n  };\n\n  const withdraw = async () => {\n    // sends withdrawal request\n    const op = await contractInstance.methods.withdraw([[\"unit\"]]).send();\n    // waits for confirmation\n    await op.confirmation(1);\n    // if confirmed\n    if (op.includedInBlock !== Infinity) {\n      const newBalance = await Tezos.tz.getBalance(userAddress);\n      setBalance(newBalance);\n    } else {\n      console.log(\"error\");\n    }\n  };\n\n  useEffect(() => {\n    (async () => {\n      // sets RPC\n      Tezos.setProvider({\n        rpc: \"http://localhost:8732\",\n        signer: new TezBridgeSigner()\n      });\n      // fetches contract storage\n      const contract = await Tezos.contract.at(contractAddress);\n      setContractInstance(contract);\n      const storage = await contract.storage();\n      // creates coffee menu\n      let coffees = [];\n      for (let key of storage.menu.keys()) {\n        coffees.push({ name: key, price: storage.menu.get(key).c[0] });\n      }\n      // updates state\n      setCoffeeMenu(coffees);\n    })();\n  }, []);\n\n  return (\n    <div className=\"App\">\n      <div className=\"wallet\">\n        {balance === undefined ? (\n          <button\n            className=\"button is-info is-light is-small\"\n            onClick={initWallet}\n          >\n            Connect your wallet\n          </button>\n        ) : (\n          <>\n            <span className=\"balance\">ꜩ {balance.toNumber() / 1000000}</span>\n            <div className=\"field is-grouped\">\n              <p className=\"control\">\n                <button\n                  className=\"button is-success is-light is-small\"\n                  onClick={async () => {\n                    setUserAddress(undefined);\n                    setBalance(undefined);\n                    setUserPoints(undefined);\n                    setIsOwner(undefined);\n                    await initWallet();\n                  }}\n                >\n                  {shortenAddress(userAddress)}\n                </button>\n              </p>\n              {isOwner && (\n                <p className=\"control\">\n                  <button\n                    className=\"button is-warning is-light is-small\"\n                    onClick={withdraw}\n                  >\n                    Withdraw ꜩ {mutezToTez(contractBalance)}\n                  </button>\n                </p>\n              )}\n            </div>\n          </>\n        )}\n      </div>\n      <div className=\"app-title\">Café Tezos</div>\n      <div className=\"logo\">\n        <img src=\"coffee-maker.png\" alt=\"logo\" />\n      </div>\n      {coffeeMenu.length === 0 ? (\n        \"Loading the menu...\"\n      ) : (\n        <Menu\n          coffeeMenu={coffeeMenu}\n          contractInstance={contractInstance}\n          userAddress={userAddress}\n          setBalance={setBalance}\n          Tezos={Tezos}\n          userPoints={userPoints}\n          setUserPoints={setUserPoints}\n        />\n      )}\n      {/*<div>Icons made by <a href=\"https://www.flaticon.com/authors/iconixar\" title=\"iconixar\">iconixar</a> from <a href=\"https://www.flaticon.com/\" title=\"Flaticon\">www.flaticon.com</a><a href=\"https://www.vecteezy.com/free-vector/coffee-cute\">Coffee Cute Vectors by Vecteezy</a></div>*/}\n    </div>\n  );\n};\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}